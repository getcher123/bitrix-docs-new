# План реализации RAG для Bitrix Markdown‑vault

Цель: получить локальную RAG‑систему, которая отвечает на вопросы по Bitrix и всегда ссылается на файлы из `docs/`.

- [ ] 1. Зафиксировать цели и аудиторию (разработчики/администраторы/интеграторы).
- [ ] 2. Согласовать режим работы (offline/online), требования по приватности и доступу.
- [ ] 3. Определить состав корпуса (`docs/**/*.md`) и список исключений (служебные файлы, `vault-nav`).
- [ ] 4. Утвердить схему метаданных: `path`, `section`, `module`, `course_id`, `lesson_id`, `title`, `heading_path`.
- [ ] 5. Настроить парсер Markdown с сохранением структуры H1/H2/H3 и блоков кода/таблиц.
- [ ] 6. Реализовать очистку шума: вырезать `<!-- vault-nav:start -->…<!-- vault-nav:end -->`.
- [ ] 7. Реализовать чанкинг по заголовкам, без разрыва кода/таблиц, с overlap.
- [ ] 8. Добавить нормализацию текста (пробелы, невидимые символы) без потери смысла.
- [ ] 9. Сохранить карту чанков и их хэши для инкрементальной индексации.
- [ ] 9.1. Развернуть эндпоинты `bge-m3`/`bge-reranker-v2-m3` (Colab) и зафиксировать URL/ключи.
- [ ] 9.2. Реализовать клиент к `/embed` и `/rerank` (таймауты/ретраи/кеш/health-check).
- [ ] 10. Выбрать и поднять векторную БД (Qdrant/pgvector).
- [ ] 11. Построить индекс эмбеддингов и записать payload‑метаданные.
- [ ] 12. Построить BM25‑индекс (лексический поиск) для гибридного retrieval.
- [ ] 13. Внедрить гибридный поиск (BM25 + vector) с RRF‑слиянием.
- [ ] 14. Добавить reranker для топ‑10 результатов.
- [ ] 15. Реализовать роутер запросов по секциям (classic/D7/REST/courses/user_help).
- [ ] 16. Настроить prompt‑шаблон: обязательные локальные ссылки, запрет галлюцинаций.
- [ ] 17. Добавить fallback: если уверенности нет — “не найдено” + рекомендации.
- [ ] 18. Подготовить набор контрольных вопросов (50–100) и эталонные ответы.
- [ ] 19. Прогнать базовую оценку (recall@k, MRR, корректность ссылок).
- [ ] 20. Подготовить API‑слой (FastAPI): `/search`, `/answer`, `/health`.
- [ ] 21. Подготовить UI/CLI (поиск, просмотр источников, быстрые фильтры).
- [ ] 22. Настроить логирование и метрики (latency, hit‑rate, пустые ответы).
- [ ] 23. Настроить инкрементальные обновления по `git diff`/`mtime`.
- [ ] 24. Документировать процесс обновления индекса и версионирование.
- [ ] 25. Провести пилот с пользователями и собрать обратную связь.
- [ ] 26. Зафиксировать критерии приемки и план регресс‑тестов.
