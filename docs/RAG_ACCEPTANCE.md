# Критерии тестирования и приемки RAG‑системы

## 1) Индексация и целостность

- 100% файлов `docs/**/*.md` (кроме исключений) проиндексированы без ошибок.
- Количество чанков соответствует ожиданиям и стабильно между запусками.
- Метаданные заполнены: `path`, `section`, `title`, `heading_path`.
- В индекс не попали `vault-nav` блоки и дублирующие шаблоны.

## 2) Корректность выдачи и ссылок

- В каждом ответе есть 2–4 локальные ссылки на файлы `docs/...`.
- Ссылки валидны (файлы существуют), без `http://` внутри ответа.
- Для типовых вопросов (набор 50–100 запросов) ≥ 90% ответов подтверждаются источниками.

## 3) Retrieval‑метрики

- Recall@10 ≥ 0.85 по эталонному набору вопросов.
- MRR ≥ 0.70 для top‑10.
- Для queries с явными сущностями (класс/метод) попадание в top‑5 ≥ 95%.

## 4) Генерация ответов

- Отсутствуют ответы “из воздуха”: если в индексах нет данных, ответ “не найдено”.
- Ответы краткие, без повторов; основной фокус на фактах из источников.
- Кодовые примеры не искажаются и берутся из контекста.

## 5) Маршрутизация и фильтры

- Запросы по REST (`crm.*`, `tasks.*`) ищутся в `docs/bitrix24_api/`.
- D7‑запросы (`Bitrix\\`) ищутся в `docs/d7/`.
- Курс/урок → `docs/courses/`.
- Пользовательские инструкции → `docs/user_help/`.

## 6) Производительность

- P95 ответа (retrieval + LLM) ≤ 3–5 секунд на целевой машине.
- Индексация полного корпуса ≤ 2–4 часа (зависит от железа).
- Инкрементальная индексация (50–100 файлов) ≤ 5–10 минут.

## 7) Надежность и регрессии

- Регресс‑набор выполняется после каждого обновления индекса.
- Повторный запуск даёт те же ссылки при одинаковом запросе.
- Логи содержат: id запроса, секцию, top‑k, время, пустые ответы.

## 8) Безопасность

- Режимы работы описаны явно (strict offline / hybrid / cloud).
- В strict offline‑режиме нет сетевых вызовов (используются только локальные модели).
- В hybrid/cloud‑режиме сетевые вызовы разрешены только к allowlist‑доменам (LLM и/или model endpoints), ключи хранятся вне кода (env/secret‑store), включены таймауты и ретраи.
- Локальные пути не раскрывают приватные данные.

## 9) Эндпоинты моделей (если используются)

- `/health` подтверждает доступность эндпоинта перед индексацией/запросами.
- При недоступности `/embed` или `/rerank` система:
  - не падает,
  - логирует инцидент,
  - включает fallback (например BM25‑only или без rerank) и явно помечает это в ответе/метриках.

## 10) Процедура приемки

- Провести полный прогон тест‑набора.
- Зафиксировать результаты метрик в отчете.
- Подписать решение о запуске и график обновлений индекса.
