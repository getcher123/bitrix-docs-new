# Вычисление ID начальника

**Навигация**
- [← Оглавление курса](index.md)
- [← Предыдущий: 2908 — Арифметические действия в бизнес-процессе](lesson_2908.md)
- [Следующий: 15308 — Работа с пользовательским полем сотрудника из БП →](lesson_15308.md)

Официальная страница урока: https://dev.1c-bitrix.ru/learning/course/index.php?COURSE_ID=57&LESSON_ID=2172

|  | ### Определяем начальника |
| --- | --- |




Вычислим начальника автора документа с помощью действия PHP-код, то есть без использования действия выбора пользователя.




В этом коде переменная `$num` отвечает за уровень начальника (`1` – непосредственный начальник, `2` – начальник начальника,...). ID начальника в формате БП (т.е. вида `user_X`) записывается в переменную с именем `var5`. Эта переменная должна быть создана в параметрах БП и должна иметь тип привязки к пользователю.



```

// Уровень начальника:
// 1 — непосредственный начальник,
// 2 — начальник начальника и так далее.
$num = 2;

// Получаем ID автора документа из переменной БП {=Document:CREATED_BY} (формат "user_X")
// Обрезаем "user_" и преобразуем в число
$userId = substr("{=Document:CREATED_BY}", 5);
$userId = intval($userId);

// Проверяем, что ID пользователя валиден
if ($userId > 0) {
    // Подключаем модуль интранета (требуется для работы с оргструктурой)
    CModule::IncludeModule("intranet");

    // Получаем данные пользователя, включая его подразделение (UF_DEPARTMENT)
    $dbUser = CUser::GetByID($userId);
    $arUser = $dbUser->Fetch();

    if ($arUser) {
        $i = 0;          // Текущий уровень иерархии
        $found = true;   // Флаг, что руководитель найден

        // Поднимаемся вверх по иерархии, пока не достигнем нужного уровня ($num)
        // или пока не найдем, что выше нет руководителей
        while ($i < $num && $found) {
            $i++;
            $found = false; // Сбрасываем флаг перед поиском на каждом уровне

            // Ищем руководителей для текущего пользователя
            // Параметры:
            // - UF_DEPARTMENT: подразделение пользователя
            // - ID пользователя (исключаем его из результатов)
            // - true: искать только непосредственных руководителей
            $arManagers = CIntranetUtils::GetDepartmentManager(
                $arUser["UF_DEPARTMENT"],
                $arUser["ID"],
                true
            );

            // Если есть хотя бы один руководитель...
            if (!empty($arManagers)) {
                // Берем первого руководителя (может быть несколько)
                $arUser = reset($arManagers);
                $found = true; // Указываем, что переход на уровень выше удался
            }
        }

        // Если нужный уровень руководителя найден...
        if ($found) {
            // Записываем результат в переменную БП (в формате "user_X")
            $rootActivity = $this->GetRootActivity();
            $rootActivity->SetVariable("var5", "user_" . $arUser["ID"]);
        }
        // Иначе переменная var5 не изменится (можно добавить логирование ошибки)
    }
}
```




- Для работы кода необходимо корректно заполнить поле `UF_DEPARTMENT` у пользователей.
- Если руководитель не найден на каком-то уровне, переменная `var5` не будет изменена.
