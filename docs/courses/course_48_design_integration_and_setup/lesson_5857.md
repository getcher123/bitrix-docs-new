# Сценарий автоматизации контроля оказания услуг

**Навигация**
- [← Оглавление курса](index.md)
- [← Предыдущий: 6306 — Реализация сценария использования абонементов на посещения](lesson_6306.md)
- [Следующий: 5823 — Автоматизация исполнения проекта →](lesson_5823.md)

Официальная страница урока: https://dev.1c-bitrix.ru/learning/course/index.php?COURSE_ID=48&LESSON_ID=5857

### Постановка задачи





Последовательно рассмотрим, как с помощью бизнес-процесса, использующего инструменты *Битрикс24*, может быть реализован возможный вариант автоматизации контроля исполнения работ.




**Примечание:**данный сценарий для своего использования подразумевает как минимум базовые знания о бизнес-процессах и других инструментах вашего портала.




Подойдет для компаний, схема работы которых выглядит ориентировочно следующим образом:




- продажа менеджером услуги, клиент оплачивает счет;
- руководитель получает необходимую информацию об объекте заказчика и выбирает исполнителя;
- передача исполнителю перечня документов для заполнения;
- выполнение работы на объекте клиента;
- проверка менеджером документов;
- подготовка акта и отчета, уведомление заказчика о завершении работы;
- менеджер доставляет клиенту акт и отчет.





### Сценарий




Менеджер, являясь ответственным за сделку, ведет ее в CRM и после того, как клиент оплачивает счет по ней, переводит ее в стадию

			**Оплачено**

                    для создания такой стадии сделки воспользуйтесь справочниками CRM:

![](../../../images/courses/48/dev.1c-bitrix.ru/images/curs_b24/example/crm_reference_stage.png)

		.





После смены стадии запускается бизнес-процесс на изменение сделки:




![](../../../images/courses/48/dev.1c-bitrix.ru/images/curs_b24/example/my_bp_1.png)




Сначала бизнес-процесс проверяет, является ли стадия сделки равной **Оплачено** (действие **Проверка стадии сделки**). Для избежания выполнения бизнес-процесса при каком-либо редактировании сделки со статусом **Оплачено**, предварительно было создано пользовательское поле  **Изменялась стадия сделки?** со значением по умолчанию **0**, при котором  бизнес-процесс пойдет по своей основной ветке, в конце которой значение данного поля меняется на **1**.




Чтобы предусмотреть ситуацию, при которой стадия сделки откатывается от **Оплачено**, а затем снова в нее возвращается (что требует повторного запуска бизнес-процесса), было задействовано уравнивание нулю значения поля **Изменялась стадия сделки?** в случае, если после изменения сделка находится в стадии, отличной от **Оплачено** (действие **Изменение значения пользовательского поля** в ветке **Не оплачено**).






Далее в главной ветке бизнес-процесса идет [запрос дополнительной информации](/learning/course/index.php?COURSE_ID=48&LESSON_ID=3782) от начальника отдела (действие **Выбор сотрудника для осмотра объекта**), которому следует выбрать своего сотрудника для выезда к заказчику. Данное действие при детальном просмотре выглядит следующим образом:




![](../../../images/courses/48/dev.1c-bitrix.ru/images/curs_b24/example/select_empl.png)




В описании добавлены необходимые для руководителя данные из сделки, такие как комментарий, контакт, компания. Добавлено поле типа **Привязка к пользователю**, через которое идентификатор выбранного сотрудника будет сохранен в переменной **Сотрудник**.




При переходе бизнес-процесса к данному действию, требующему ответа от руководителя отдела, у последнего появится запрос об этом в виде цифры рядом с пунктом бизнес-процессы основного меню:




![](../../../images/courses/48/dev.1c-bitrix.ru/images/curs_b24/example/bp_1.png)




При просмотре задания руководитель будет видеть следующую форму:




![](../../../images/courses/48/dev.1c-bitrix.ru/images/curs_b24/example/520000.png)




В [следующем действии](/learning/course/index.php?COURSE_ID=48&LESSON_ID=3785) стадия сделки меняется на **В обработке** (действие **Сделка - "В обработке"**), а руководителю, аналогично запросу на выбор сотрудника, посылается задание (действие **Первичное формирование ведомости документов**) на формирование ведомости документов, которые необходимо забрать у заказчика:




![](../../../images/courses/48/dev.1c-bitrix.ru/images/curs_b24/example/list_docs.png)




Составленная ведомость сохранится в переменной **Список документов**, созданной в форме создания запроса дополнительной информации:




![](../../../images/courses/48/dev.1c-bitrix.ru/images/curs_b24/example/doc_list.png)




Затем в бизнес-процессе ставится задача подчиненному (выбранному сотруднику):




![](../../../images/courses/48/dev.1c-bitrix.ru/images/curs_b24/example/task_for_semen.png)




- бизнес-процесс приостанавливается на время выполнения задачи;
- в качестве ответственного ставится выбранный руководителем сотрудник (переменная **Сотрудник**);
- с помощью [выражения](/learning/course/index.php?COURSE_ID=48&LESSON_ID=3814) `=Dateadd({=System:Date}, "2 days")` крайним сроком указано 2 дня от текущей даты;
- в описание задачи перенесен список документов, составленный руководителем (переменная **Список документов**) и поля сделки, такие как идентификатор контакта\компании, комментарий;
- наблюдателем выбран ответственный по сделке менеджер;
- задача находится в группе **Продажи**, что позволит в дальнейшем отследить выполнение задач через данную группу;
- задача привязывается к текущей сущности CRM (сделке).




Для ответственного задача будет выглядеть следующим образом:




![](../../../images/courses/48/dev.1c-bitrix.ru/images/curs_b24/example/task_semen_view.png)




После выполнения своего задания ответственный сотрудник может вложить отсканированные документы в комментарии к задаче, либо принести их лично менеджеру на проверку.




После завершения задачи запускается [цикл](/learning/course/index.php?COURSE_ID=48&LESSON_ID=3792) утверждения документов менеджером:




![](../../../images/courses/48/dev.1c-bitrix.ru/images/curs_b24/example/while.png)




Специально для данного цикла в параметрах шаблона бизнес-процесса была предварительно создана переменная **Утверждение документов** типа **Да\Нет**. Цикл будет выполняться до тех пор, пока значение данной переменной не изменится (т.е. произойдет утверждение документов). В случае, если менеджер не утверждает документы, ответственному сотруднику ставится задача **Забрать документы на заполнение**, в которой будет отображен комментарий менеджера о том, что следует исправить, внесенный им при отклонении документа (Дополнительные результаты &gt; Утверждение документов &gt; Комментарий).




После утверждения документов руководителю отдела ставится задача о подготовке отчета, а менеджеру, не останавливая бизнес-процесс на время выполнения задачи - о передаче акта.




Затем заказчику от имени менеджера (ответственный за сделку) [отсылается письмо](/learning/course/index.php?COURSE_ID=48&LESSON_ID=3802) на электронный адрес с сообщением о завершении работы:




![](../../../images/courses/48/dev.1c-bitrix.ru/images/curs_b24/example/send_email_client.png)




В в качестве адреса получателя указывается значение пользовательского поля **email**, предварительно созданного для сделок.




После этого следуют действия **Изменение полей документа**, с помощью которых меняется стадия сделки на **Сделка заключена** и значение пользовательского поля **Изменялась стадия сделки?**, о котором было сказано выше.




В нашем случае менеджер и руководитель постоянно в курсе стадии работы с клиентом, являясь либо ответственными\постановщиками, либо наблюдателями всех задач по сделке. Отследить события, текущие дела и задачи по сделке можно в форме ее просмотра (закладки

			**Лента**, **Дела**, **История**

                    ![](../../../images/courses/48/dev.1c-bitrix.ru/images/curs_b24/example/deal_lenta_view.png)

		):







**Примечание:**вы можете [скачать шаблон](/images/curs_b24/example/control.bpt) данного бизнес-процесса.
